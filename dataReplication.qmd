---
title: "dataReplication"
format: html
editor: visual
toc: true
toc-depth: 3
toc-location: right
toc-float: true
---

# Data Replication Project: Replicating a Social Network Analysis

[**Based on: Blaszczyk, M. B. (2018). Consistency in social network position over changing environments in a seasonally breeding primate. *Behavioral Ecology and Sociobiology*, *72*(1), 11. <https://doi.org/10.1007/s00265-017-2425-y>**]{.underline}

## Background

### Aims

The original study cited above aimed to investigate the consistency of social behavior in wild vervet monkeys (*Chlorocubus pygerthrus*) across three seasons, the breeding season, winter season, and birthing season. Blaszczyk created grooming networks for each season and measured the repeatability of seven network metrics (In-/Out-degree, In-/Out-strength, betweenness, eigenvector centrality, and clustering coefficient) along with the effects of sex and dominance rank on these metrics.

### Data Used

Blaszczyk used 20-minute continuous focal sampling to record grooming bouts lasting at least 5 seconds. The final data included who groomed and who was groomed, how long the grooming bout lasted, the total number of minutes the actor and receiver were seen, the total amount of time in seconds the same dyad was seen together, and grooming rate (grooming bout time/time dyad seen together). A different dataset was used for each season, resulting in three unique datasets characterizing grooming dyads for the group under study. Additionally, individuals' IDs, sex, and elo rating for each season was stored in a fourth dataset.

### Analysis

The initial analysis used function in the {igraph} package to construct grooming networks for each season. These networks were one directed and weighted based on grooming rate. {igraph} as also used to calculate the seven network metrics. Elo-ratings were calculated using the {EloRating} package and converted to ranks on the last day of each season (IDs_Sex_EloScores in OGData). To test the repeatability of each metric across seasons, linear mixed effects models (LMMs) were run using the {rptR} package. Models were run for the whole mixed sex sample (n = 26), females (n = 16), and males (n = 10) with season being a random effect. These models were also all run again with rank included as a fixed effect. Additionally, sex was used as a fixed effect for (G)LMMs to examine sex differences and the effects of dominance rank on all social network metrics. Node-based permutation tests with 1000 iterations were used on all metrics to evaluate the significance of repeatability. In order to test for the collinearity between each pair of metrics, Spearman rank correlation was used. All mixed models were fit with the {lme4} package.

### Conclusions

Blaszczyk found that, based on the repeatability of each network metric, vervet monkey social network position was consistent over the three seasons. Grooming in-strength, out-strength, eigenvector centrality, and in-degree were the most repeatable for both sexes. Betweenness showed no consistency across seasons for both sexes. Only males were consistent in out-degree and clustering coefficients.

## Tools

First, we will load in the libraries with the functions we need to conduct the analysis

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(igraph)
library(EloRating)
library(rptR)
library(lme4)
library(ggplot2)
library(cowplot)
library(mosaic)
```

## Data

Next, we will load in the data using the raw links provided by github. The elo variable will hold the data with demographic details and elo rating, s1 will hold all the season 1 data, s2 will hold the season 2 data, and s3 will hold the season 3 data.

```{r}
#| message: false
#| warning: false
f <- "https://raw.githubusercontent.com/NicoJaws23/dataReplication/refs/heads/main/IDs_Sex_EloScores.csv"
elo <- read_csv(f)

f1 <- "https://raw.githubusercontent.com/NicoJaws23/dataReplication/refs/heads/main/GroomDyads_S1.csv"
s1 <- read_csv(f1)

f2 <- "https://raw.githubusercontent.com/NicoJaws23/dataReplication/refs/heads/main/GroomDyads_S2.csv"
s2 <- read_csv(f2)

f3 <- "https://raw.githubusercontent.com/NicoJaws23/dataReplication/refs/heads/main/GroomDyads_S3.csv"
s3 <- read_csv(f3)
```

## Adjustments

Next, we will make some adjustments to the original data. Considering that the analysis uses season as a random effect, we ill add a column which holds a value for the corresponding season. We will also have a name for the season held in another column along with columns which convert the groom time and dyad time to minutes. Finally, we will combine all the data into one data frame.

```{r}
#| message: false
#| warning: false
s1 <- mutate(s1, Season = 1, sType = "Mating", groomMin = total.groom.secs/60, dyadObsMin = dyad.obs.secs/60)
s2 <- mutate(s2, Season = 2, sType = "Winter", groomMin = total.groom.secs/60, dyadObsMin = dyad.obs.secs/60)
s3 <- mutate(s3, Season = 3, sType = "Birth", groomMin = total.groom.secs/60, dyadObsMin = dyad.obs.secs/60)

#Combine all 3 seasons into one big table
com <- bind_rows(list(s1, s2, s3))

```

## Plots

Now will will plot each seasons social network. First, we need to define the edges for each network which we will store in a variable names sXEdges. This will be a data frame with the actor, recipient, and grooming rate. Next we will graph the social network using the graph_from_data_frame() function which will take out edges data as an argument along with setting directed to TRUE. In the original study, females are white circles while males are gray circles. To do this, we will call the colors of the vertices of the graph and set them to be based on vertices name which is based on each individuals ID. This will be linked to the elo table which has the sex of each individual which be used to assign the proper color to each vertex. Then, using the plot.igraph() function, we will plot the social network. This will be repeated for each season. I was not able to figure out how to combine all three figures into one nice row, but it is meant to represent figure 1.

### Season 1

```{r}
#Season 1
s1Edges <- data.frame(from = s1$"Actor", to = s1$"Recip", weight = s1$groom.rate)
s1G <- graph_from_data_frame(d = s1Edges, directed = TRUE)

V(s1G)$color <- sapply(V(s1G)$name, function(name) {
  row <- which(elo$ID == name)
  if(elo$Sex[row] == "F") {
    "white"
  } else {
    "gray"
  }
})

s1p <- plot.igraph(s1G, 
            vertex.shape = "circle",
            vertex.size = 15,
            vertex.color = V(s1G)$color,
            vertex.label = "",
            edge.curved = .75,
            main = c("Season 1",
            "March - May",
            "FOH = 497", " ND = 0.45"))
```

### Season 2

```{r}
s2Edges <- data.frame(from = s2$"Actor", to = s2$"Recip", weight = s2$groom.rate)
s2G <- graph_from_data_frame(d = s2Edges, directed = TRUE)

V(s2G)$color <- sapply(V(s2G)$name, function(name) {
  row <- which(elo$ID == name)
  if(elo$Sex[row] == "F") {
    "white"
  } else {
    "gray"
  }
})

s2p <- plot.igraph(s2G, 
            vertex.shape = "circle",
            vertex.size = 15,
            vertex.color = V(s1G)$color,
            vertex.label = "",
            edge.curved = .75,
            main = c("Season 2",
            "June - September",
            "FOH = 967.1", " ND = 0.71"))
```

### Season 3

```{r}
s3Edges <- data.frame(from = s3$"Actor", to = s3$"Recip", weight = s3$groom.rate)
s3G <- graph_from_data_frame(d = s3Edges, directed = TRUE)

V(s3G)$color <- sapply(V(s3G)$name, function(name) {
  row <- which(elo$ID == name)
  if(elo$Sex[row] == "F") {
    "white"
  } else {
    "gray"
  }
})

s3p <- plot.igraph(s3G, 
            vertex.shape = "circle",
            vertex.size = 15,
            vertex.color = V(s1G)$color,
            vertex.label = "",
            edge.curved = .75,
            main = c("Season 3",
            "October - December",
            "FOH = 705.2", " ND = 0.52"))
```

## Calculating Metrics

Next, we will calculate the each of the 7 metrics used in the study, in-degree, out-degree, in-strength, out-strength, betweenness, eigenvector centrality, and clustering coefficient. Each metric will be stored in a corresponding data frame for each season which will then be combined to analyze for repeatability. Additionally, the combined data frame for each metric will be mutated so that season and rank (numeric values) are converted to factors.

### In-Degree & Out-Degree

Using the {igraph} function degree() twice for each season, one where mode is set to "in" and another to "out"

```{r}
s1IO <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::degree(s1G, mode = "in"), Out = igraph::degree(s1G, mode = "out"), Season = 1, rank = elo$Elo.May, row.names = NULL)
s2IO <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::degree(s2G, mode = "in"), Out = igraph::degree(s2G, mode = "out"), Season = 2, rank = elo$Elo.Sep, row.names = NULL)
s3IO <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::degree(s3G, mode = "in"), Out = igraph::degree(s3G, mode = "out"), Season = 3, rank = elo$Elo.Dec, row.names = NULL)
IO <- bind_rows(list(s1IO, s2IO, s3IO))
IO <- IO |> mutate(Season = as.factor(Season), rank = as.factor(rank))
```

### In-Strength & Out-Strength

Using the {igraph} function strength() twice, once with mode set to "in" and another set to "out"

```{r}
s1S <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::strength(s1G, mode = "in"), Out = igraph::strength(s1G, mode = "out"), Season = 1, rank = elo$Elo.May, row.names = NULL)
s2S <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::strength(s2G, mode = "in"), Out = igraph::strength(s2G, mode = "out"), Season = 2, rank = elo$Elo.Sep, row.names = NULL)
s3S <- data.frame(ID = elo$ID, Sex = elo$Sex, In = igraph::strength(s3G, mode = "in"), Out = igraph::strength(s3G, mode = "out"), Season = 3, rank = elo$Elo.Dec, row.names = NULL)
strength <- bind_rows(list(s1S, s2S, s3S))
strength <- strength |> mutate(Season = as.factor(Season), rank = as.factor(rank))
```

### Betweenness

This metric will be calculated using the {igraph} function betweenness().

```{r}
s1B <- data.frame(ID = elo$ID, Sex = elo$Sex, bt = igraph::betweenness(s1G, cutoff = -1), Season = 1, rank = elo$Elo.May, row.names = NULL)
s2B <- data.frame(ID = elo$ID, Sex = elo$Sex, bt = igraph::betweenness(s2G, cutoff = -1), Season = 2, rank = elo$Elo.Sep, row.names = NULL)
s3B <- data.frame(ID = elo$ID, Sex = elo$Sex, bt = igraph::betweenness(s3G, cutoff = -1), Season = 3, rank = elo$Elo.Dec, row.names = NULL)
b <- bind_rows(list(s1B, s2B, s3B))
b <- b |> mutate(Season = as.factor(Season), rank = as.factor(rank))
```

### Eigenvector Centrality

This metric will calculated using the {igraph} function eigen_centrality().

```{r}
s1E <- data.frame(ID = elo$ID, Sex = elo$Sex, EC = eigen_centrality(s1G), Season = 1, rank = elo$Elo.May, row.names = NULL)
s2E <- data.frame(ID = elo$ID, Sex = elo$Sex, EC = eigen_centrality(s2G), Season = 2, rank = elo$Elo.Sep, row.names = NULL)
s3E <- data.frame(ID = elo$ID, Sex = elo$Sex, EC = eigen_centrality(s3G), Season = 3, rank = elo$Elo.Dec, row.names = NULL)
EC <- bind_rows(list(s1E, s2E, s3E))
EC <- EC |> mutate(Season = as.factor(Season), rank = as.factor(rank))
```

### Clustering Coefficient

Finally we have the clustering coefficient which is calculated using the {igraph} function transitivity(), the type is local per the methods of the original study.

```{r}
s1CC <- data.frame(ID = elo$ID, Sex = elo$Sex, CC = igraph::transitivity(s1G, type = "local"), Season = 1, rank = elo$Elo.May, row.names = NULL)
s2CC <- data.frame(ID = elo$ID, Sex = elo$Sex, CC = igraph::transitivity(s2G, type = "local"), Season = 2, rank = elo$Elo.Sep, row.names = NULL)
s3CC <- data.frame(ID = elo$ID, Sex = elo$Sex, CC = igraph::transitivity(s3G, type = "local"), Season = 3, rank = elo$Elo.Dec, row.names = NULL)
CC <- bind_rows(list(s1CC, s2CC, s3CC))
CC <- CC |> mutate(Season = as.factor(Season), rank = as.factor(rank))
```

## Plotting Metrics

Here I will use functions from {ggplot2} and {cowplot} to visualize the changes in each metric over the three season. This is meant to reflect the graphs in Figure 2 of the original study

```{r}
InDegreePlot <- ggplot(data = IO, mapping = aes(x = as.numeric(Season), y = In, color = ID)) +
  geom_line() +
  theme(legend.position = "none") +
  ggtitle("In-Degree")

OutDegreePlot <- ggplot(data = IO, mapping = aes(x = as.numeric(Season), y = Out, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("Out-Degree")

InStrengthPlot <- ggplot(data = strength, mapping = aes(x= as.numeric(Season), y= In, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("In-Strength")

OutStrengthPlot <- ggplot(data = strength, mapping = aes(x = as.numeric(Season), y = Out, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("Out-Strength")

betweenPlot <- ggplot(data = b, mapping = aes(x = as.numeric(Season), y = bt, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("Betweenness")

eigenPlot <- ggplot(data = EC, mapping = aes(x = as.numeric(Season), y = EC.vector, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("Eigenvector Centrality")

clusterPlot <- ggplot(data = CC, mapping = aes(x = as.numeric(Season), y = CC, color = ID)) +
  geom_line()+
  theme(legend.position = "none") +
  ggtitle("Clustering Coefficient")

cowplot <- plot_grid(InDegreePlot, OutDegreePlot, InStrengthPlot, OutStrengthPlot, betweenPlot, eigenPlot, clusterPlot, nrow = 3, ncol = 3)
cowplot
```

## Running Models

Now we will fun the repeatability models for each of the metrics. Each of the 7 metrics has 5 models associated with it, 1 for all individual combined, 1 for just females, 1 for just females but with rank as a fixed effect, 1 for just males, and 1 for just males with rank as a fixed effect. All models use the rpt() function from {rptR}. In all models, the season and individual ID are random effects

### In-Degree & Out-Degree

```{r}
#| message: false
#| warning: false
#Degree repeatability
#In-degree
IOm <- rpt(In ~ (1|ID) + (1|Season),
           grname = "ID",
           data = IO,
           datatype = "Gaussian")
summary(IOm)
#Females
ioFemales <- IO |>
  filter(Sex == "F")
IOmF <- rpt(In ~ (1|ID) + (1|Season),
            grname = "ID",
            data = ioFemales,
            datatype = "Gaussian")
summary(IOmF)
#Females with Rank
IOmF_rank <- rpt(In ~ rank + (1|ID) + (1|Season),
                 grname = "ID",
                 data = ioFemales,
                 datatype = "Gaussian")
summary(IOmF_rank)
#Males
ioMales <- IO |>
  filter(Sex == "M")
IOmM <- rpt(In ~ (1|ID) + (1|Season),
            grname = "ID",
            data = ioMales,
            datatype = "Gaussian")
summary(IOmM)
#Males with Rank
IOmM_rank <- rpt(In ~ rank + (1|ID) + (1|Season),
            grname = "ID",
            data = ioMales,
            datatype = "Gaussian")
summary(IOmM_rank)
#Out-degree
IOmOut <- rpt(Out ~ (1|ID) + (1|Season),
              grname = "ID",
              data = IO,
              datatype = "Gaussian")
summary(IOmOut)
#Females
ioOutFemales <- rpt(Out ~ (1|ID) + (1|Season),
                    grname = "ID",
                    data = ioFemales,
                    datatype = "Gaussian")
summary(ioOutFemales)
#Females with rank
ioOutFemales_rank <- rpt(Out ~ rank + (1|ID) + (1|Season),
                    grname = "ID",
                    data = ioFemales,
                    datatype = "Gaussian")
summary(ioOutFemales_rank)
#Males
ioOutMales <- rpt(Out ~ (1|ID) + (1|Season),
                  grname = "ID",
                  data = ioMales,
                  datatype = "Gaussian")
summary(ioOutMales)
#Males with rank
ioOutMales_rank <- rpt(Out ~ rank + (1|ID) + (1|Season),
                  grname = "ID",
                  data = ioMales,
                  datatype = "Gaussian")
summary(ioOutMales_rank)
```

### In-Strength & Out-Strength

The out-strength values used in the male-only models were logged transformed to meet assumptions

```{r}
#| message: false
#| warning: false
#Strength Repeatability
#In-Strength
inStrength <- rpt(In ~ (1|ID) + (1|Season),
                  grname = "ID",
                  data = strength,
                  datatype = "Gaussian")
summary(inStrength)
#Females
strengthF <- strength |>
  filter(Sex == "F")
inStrengthF <- rpt(In ~ (1|ID) + (1|Season),
                   grname = "ID",
                   data = strengthF,
                   datatype = "Gaussian")
summary(inStrengthF)
#Females with rank
inStrengthF_rank <- rpt(In ~ rank + (1|ID) + (1|Season),
                   grname = "ID",
                   data = strengthF,
                   datatype = "Gaussian")
summary(inStrengthF_rank)
#Males
strengthM <- strength |>
  filter(Sex == "M")
inStrengthM <- rpt(In ~ (1|ID) + (1|Season),
                   grname = "ID",
                   data = strengthM,
                   datatype = "Gaussian")
summary(inStrengthM)
#Males with rank
inStrengthM_rank <- rpt(In ~ rank + (1|ID) + (1|Season),
                   grname = "ID",
                   data = strengthM,
                   datatype = "Gaussian")
summary(inStrengthM_rank)
#Out-Strength
outStrength <- rpt(Out ~ (1|ID) + (1|Season),
                   grname = "ID",
                   data = strength,
                   datatype = "Gaussian")
summary(outStrength)
#Females
outStrengthF <- rpt(Out ~ (1|ID) + (1|Season),
                    grname = "ID",
                    data = strengthF,
                    datatype = "Gaussian")
summary(outStrengthF)
#Females with rank
outStrengthF_rank <- rpt(Out ~ rank + (1|ID) + (1|Season),
                    grname = "ID",
                    data = strengthF,
                    datatype = "Gaussian")
summary(outStrengthF_rank)
#Males
outStrengthM <- rpt(Out ~ (1|ID) + (1|Season),
                    grname = "ID",
                    data = strengthM,
                    datatype = "Gaussian")
summary(outStrengthM)
#Males with rank
outStrengthM_rank <- rpt(Out ~ rank + (1|ID) + (1|Season),
                    grname = "ID",
                    data = strengthM,
                    datatype = "Gaussian")
summary(outStrengthM_rank)

#Male Out-Strength logged
strengthM <- strengthM |>
  mutate(logOut = log(Out))
#New out strength model
outStrengthM_log <- rpt(logOut ~ (1|ID) + (1|Season),
                    grname = "ID",
                    data = strengthM,
                    datatype = "Gaussian")
summary(outStrengthM)
#Males with rank
outStrengthM_rank_log <- rpt(logOut ~ rank + (1|ID) + (1|Season),
                         grname = "ID",
                         data = strengthM,
                         datatype = "Gaussian")
summary(outStrengthM_rank_log)
```

### Betweenness

For the betweenness models, a generalized linear mixed effects model (GLMMs) with a Poisson distribution was used instead of the standard linear mixed model. This was done using the rptPoisson() function in {rptR}

```{r}
#| message: false
#| warning: false
#FOR BETWEENNESS: GLMMs w/ Poisson dist
btM_glmm <- rptPoisson(bt ~ (1|ID) + (1|Season),
           grname = "ID",
           data = b)
summary(btM_glmm)
#Females
bFemales <- b |>
  filter(Sex == "F")
btM_Females_glmm <- rptPoisson(bt ~ (1|ID) + (1|Season),
                   grname = "ID",
                   data = bFemales)
summary(btM_Females_glmm)
#Females with rank
btM_Females_rank_glmm <- rptPoisson(bt ~ rank + (1|ID) + (1|Season),
                        grname = "ID",
                        data = bFemales)
summary(btM_Females_rank_glmm)
#Males
bMales <- b |>
  filter(Sex == "M")
btM_Males_glmm <- rptPoisson(bt ~ (1|ID) + (1|Season),
                 grname = "ID",
                 data = bMales)
summary(btM_Males_glmm)
#Males with rank
btM_Males_rank_glmm <- rptPoisson(bt ~ rank + (1|ID) + (1|Season),
                      grname = "ID",
                      data = bMales)
summary(btM_Males_rank_glmm)
```

### Eigenvector Centrality

Male-only models had eigenvector centrality log transformed to meet model assumptions

```{r}
#| message: false
#| warning: false
#Eigenvector Centrality
egCent <- rpt(EC.vector ~ (1|ID) + (1|Season),
              grname = "ID",
              data = EC,
              datatype = "Gaussian")
summary(egCent)
#Females
ecFemales <- EC |>
  filter(Sex == "F")
egCentF <- rpt(EC.vector ~ (1|ID) + (1|Season),
               grname = "ID",
               data = ecFemales,
               datatype = "Gaussian")
summary(egCentF)
#Females with rank
egCentF_rank <- rpt(EC.vector ~ rank + (1|ID) + (1|Season),
               grname = "ID",
               data = ecFemales,
               datatype = "Gaussian")
summary(egCentF_rank)
#Males
ecMales <- EC |>
  filter(Sex == "M")
egCentM <- rpt(EC.vector ~ (1|ID) + (1|Season),
               grname = "ID",
               data = ecMales,
               datatype = "Gaussian")
summary(egCentM)
#Males with rank
egCentM_rank <- rpt(EC.vector ~ rank + (1|ID) + (1|Season),
               grname = "ID",
               data = ecMales,
               datatype = "Gaussian")
summary(egCentM_rank)


#Male eigenvectors logged
ecMales <- ecMales |>
  mutate(logEC = log(EC.vector))
#New eigenvector model
egCentM_log <- rpt(logEC ~ (1|ID) + (1|Season),
               grname = "ID",
               data = ecMales,
               datatype = "Gaussian")
summary(egCentM_log)
#Males with rank
egCentM_rank_log <- rpt(logEC ~ rank + (1|ID) + (1|Season),
                    grname = "ID",
                    data = ecMales,
                    datatype = "Gaussian")
summary(egCentM_rank_log)
```

### Clustering Coefficient

```{r}
#| message: false
#| warning: false
#Clustering coefficient, may need to recheck
ccM <- rpt(CC ~ (1|ID) + (1|Season),
           grname = "ID",
           data = CC,
           datatype = "Gaussian")
summary(ccM)
#Females
CC_Females <- CC |>
  filter(Sex == "F")
ccM_Females <- rpt(CC ~ (1|ID) + (1|Season),
                   grname = "ID",
                   data = CC_Females,
                   datatype = "Gaussian")
summary(ccM_Females)
#Females with rank
ccM_Females_rank <- rpt(CC ~ rank + (1|ID) + (1|Season),
                   grname = "ID",
                   data = CC_Females,
                   datatype = "Gaussian")
summary(ccM_Females_rank)
#Males
CC_Males <- CC |>
  filter(Sex == "M")
ccM_Males <- rpt(CC ~ (1|ID) + (1|Season),
                 grname = "ID",
                 data = CC_Males,
                 datatype = "Gaussian")
summary(ccM_Males)
#Males with rank
ccM_Males_rank <- rpt(CC ~ rank + (1|ID) + (1|Season),
                 grname = "ID",
                 data = CC_Males,
                 datatype = "Gaussian")
summary(ccM_Males_rank)
```

## Node-Based Permuation

Since individual network metric are not independent of other network members, the orignal study used a node-based permutatio approach to tests for the significance of each repeatability estimate. Individual IDs were randomized for each of the three networks before running a new repeatability model. This was repeated 1000 times. I built the following function to do this easily for each metric. The first is for the standard node based permutation, the next is for the GLMMs used for betweenenss

```{r}
nodePerm <- function(df, n, formula){
  permN <- do(n) * {
    permd <- df
    permd$ID = sample(permd$ID)
    m <- rpt(formula,
             grname = "ID",
             data = permd,
             datatype = "Gaussian")
    data.frame(R = m$R$ID)
  }
  return(permN)
}
nodePermGlmm <- function(df, n, formula){
  permN <- do(n) * {
    permd <- df
    permd$ID = sample(permd$ID)
    m <- rptPoisson(formula,
                    grname = "ID",
                    data = b)
    data.frame(R = m$R$ID)
  }
  return(permN)
}
```

### In-Degree & Out-Degree

```{r}
#In-degree
inDegPerm <- nodePerm(df = IO, n = 2, formula = In ~ (1|ID) + (1|Season))
inDegPval <- (sum(inDegPerm$R >= IOm$R) + 1) / (length(inDegPerm$R) + 1)

#In Degree Females
inDegPermF <- nodePerm(df = ioFemales, n = 10, forumula = In ~ (1|ID) + (1|Season))
inDegPermF_pval <- (sum(inDegPermF$R >= IOmF$R) + 1) / (length(inDegPermF$R) + 1)

#In Degree Females w/ rank
inDegPermFrank <- nodePerm(df = ioFemales, n = 10, forumula = In ~ rank + (1|ID) + (1|Season))
inDegPermFrank_pval <- (sum(inDegPermFrank$R >= IOmF_rank$R) + 1) / (length(inDegPermFrank$R) + 1)

#In Degree Males
inDegPermM <- nodePerm(df = ioMales, n = 10, forumula = In ~ (1|ID) + (1|Season))
inDegPermM_pval <- (sum(inDegPermM$R >= IOmM$R) + 1) / (length(inDegPermM$R) + 1)

#In Degree Males w/ rank
inDegPermMrank <- nodePerm(df = ioMales, n = 10, forumula = In ~ rank + (1|ID) + (1|Season))
inDegPermMrank_pval <- (sum(inDegPermMrank$R >= IOmM_rank$R) + 1) / (length(inDegPermMrank$R) + 1)

#Out degree
outDegPerm <- nodePerm(df = IO, n = 2, formula = Out ~ (1|ID) + (1|Season))
inDegPval <- (sum(outDegPerm$R >= IOmOut$R) + 1) / (length(outDegPerm$R) + 1)

#Out degree females
outDegPermF <- nodePerm(df = ioFemales, n = 2, formula = Out ~ (1|ID) + (1|Season))
outDegPermF_pval <- (sum(outDegPermF$R >= ioOutFemales$R) + 1) / (length(outDegPermF$R) + 1)

#Out degree females w/ rank
outDegPermFrank <- nodePerm(df = ioFemales, n = 2, formula = Out ~ rank + (1|ID) + (1|Season))
outDegPermFrank_pval <- (sum(outDegPermFrank$R >= ioOutFemales_rank$R) + 1) / (length(outDegPermFrank$R) + 1)

#Out degree males
outDegPermM <- nodePerm(df = ioMales, n = 2, formula = Out ~ (1|ID) + (1|Season))
outDegPermM_pval <- (sum(outDegPermM$R >= ioOutMales$R) + 1) / (length(outDegPermM$R) + 1)

#Out degree males w/ rank
outDegPermMrank <- nodePerm(df = ioMales, n = 2, formula = Out ~ rank + (1|ID) + (1|Season))
outDegPermMrank_pval <- (sum(outDegPermMrank$R >= ioOutMales_rank$R) + 1) / (length(outDegPermMrank$R) + 1)
```

### In-Strength & Out-Strength

```{r}
#In-strength
inStrengthPerm <- nodePerm(df = strength, n = 2, formula = In ~ (1|ID) + (1|Season))
inStrengthPerm_pval <- (sum(inStrengthPerm$R >= inStrength$R) + 1) / (length(inStrengthPerm$R) + 1)

#In-strength females
inStrengthPermF <- nodePerm(df = strengthF, n = 2, formula = In ~ (1|ID) + (1|Season))
inStrengthPermF_pval <- (sum(inStrengthPermF$R >= inStrengthF$R) + 1) / (length(inStrengthPermF$R) + 1)

#In-strength females w/ rank
inStrengthPermFrank <- nodePerm(df = strengthF, n = 2, formula = In ~ rank + (1|ID) + (1|Season))
inStrengthPermFrank_pval <- (sum(inStrengthPermFrank$R >= inStrengthF_rank$R) + 1) / (length(inStrengthPermFrank$R) + 1)

#In-strength Males
inStrengthPermM <- nodePerm(df = strengthM, n = 2, formula = In ~ (1|ID) + (1|Season))
inStrengthPermM_pval <- (sum(inStrengthPermM$R >= inStrengthM$R) + 1) / (length(inStrengthPermM$R) + 1)

#In-strength Males w/ rank
inStrengthPermMrank <- nodePerm(df = strengthM, n = 2, formula = In ~ rank + (1|ID) + (1|Season))
inStrengthPermMrank_pval <- (sum(inStrengthPermMrank$R >= inStrengthM_rank$R) + 1) / (length(inStrengthPermMrank$R) + 1)

#Out-strength
outStrengthPerm <- nodePerm(df = strength, n = 2, formula = Out ~ (1|ID) + (1|Season))
outStrengthPerm_pval <- (sum(outStrengthPerm$R >= outStrength$R) + 1) / (length(outStrengthPerm$R) + 1)

#out-strength females
outStrengthPermF <- nodePerm(df = strengthF, n = 2, formula = Out ~ (1|ID) + (1|Season))
outStrengthPermF_pval <- (sum(outStrengthPermF$R >= outStrengthF$R) + 1) / (length(outStrengthPermF$R) + 1)

#out-strength females w/ rank
outStrengthPermFrank <- nodePerm(df = strengthF, n = 2, formula = Out ~ rank + (1|ID) + (1|Season))
outStrengthPermFrank_pval <- (sum(outStrengthPermFrank$R >= outStrengthF_rank$R) + 1) / (length(outStrengthPermFrank$R) + 1)

#out-strength Males
outStrengthPermM <- nodePerm(df = strengthM, n = 2, formula = logOut ~ (1|ID) + (1|Season))
outStrengthPermM_pval <- (sum(outStrengthPermM$R >= outStrengthM_log$R) + 1) / (length(outStrengthPermM$R) + 1)

#out-strength Males w/ rank
outStrengthPermMrank <- nodePerm(df = strengthM, n = 2, formula = logOut ~ rank + (1|ID) + (1|Season))
outStrengthPermMrank_pval <- (sum(outStrengthPermMrank$R >= outStrengthM_rank_log$R) + 1) / (length(outStrengthPermMrank$R) + 1)
```

### Betweenness

```{r}
#Betweenness
btPerm <- nodePermGlmm(df = b, n = 2, formula = bt ~ (1|ID) + (1|Season))
btPerm_pval <- (sum(btPerm$R >= btM_glmm$R) + 1)/(length(btPerm$R) + 1)

#Female betweenness
btPermF <- nodePermGlmm(df = bFemales, n = 2, formula = bt ~ (1|ID) + (1|Season))
btPermF_pval <- (sum(btPermF$R >= btM_Females_glmm$R) + 1)/(length(btPermF$R) + 1)

#Female betweenness w/ rank
btPermFrank <- nodePermGlmm(df = bFemales, n = 2, formula = bt ~ rank + (1|ID) + (1|Season))
btPermFrank_pval <- (sum(btPermFrank$R >= btM_Females_rank_glmm$R) + 1)/(length(btPermF$R) + 1)

#Male betweenness
btPermM <- nodePermGlmm(df = bMemales, n = 2, formula = bt ~ (1|ID) + (1|Season))
btPermM_pval <- (sum(btPermM$R >= btM_Males_glmm$R) + 1)/(length(btPermM$R) + 1)

#Male betweenness w/ rank
btPermMrank <- nodePermGlmm(df = bMales, n = 2, formula = bt ~ (1|ID) + (1|Season))
btPermMrank_pval <- (sum(btPermM$R >= btM_Males_glmm$R) + 1)/(length(btPermM$R) + 1)
```

### Eigenvctor Centrality

```{r}
#Eigenvector
ecPerm <- nodePerm(df = EC, n = 2, forumla = EC.vector ~ (1|ID) + (1|Season))
ecPerm_pval <- (sum(ecPerm$R >= egCent$R) + 1)/(length(ecPerm$R) + 1)

#Female eigenvector
ecPermF <- nodePerm(df = ecFemales, n = 2, forumla = EC.vector ~ (1|ID) + (1|Season))
ecPermF_pval <- (sum(ecPermF$R >= egCentF$R) + 1)/(length(ecPermF$R) + 1)

#Female eigenvector w/ rank
ecPermFrank <- nodePerm(df = ecFemales, n = 2, forumla = EC.vector ~ rank + (1|ID) + (1|Season))
ecPermFrank_pval <- (sum(ecPermFrank$R >= egCentF_rank$R) + 1)/(length(ecPermFrank$R) + 1)

#Male eigenvector
ecPermM <- nodePerm(df = ecMales, n = 2, forumla = logEC ~ (1|ID) + (1|Season))
ecPermM_pval <- (sum(ecPermM$R >= egCentM_log$R) + 1)/(length(ecPermM$R) + 1)

#Male eigenvector w/ rank
ecPermFrank <- nodePerm(df = ecMales, n = 2, forumla = logEC ~ rank + (1|ID) + (1|Season))
ecPermFrank_pval <- (sum(ecPermMrank$R >= egCentM_rank_log$R) + 1)/(length(ecPermMrank$R) + 1)
```

### Clustering Coefficient

```{r}
#Clustering Coefficient
ccPerm <- nodePerm(df = CC, n = 2, formula = CC ~ (1|ID) + (1|Season))
ccPerm_pval <- (sum(ccPerm$R >= ccM$R) + 1)/(length(ccPerm$R) + 1)

#Female CC
ccPermF <- nodePerm(df = CC_Females, n = 2, formula = CC ~ (1|ID) + (1|Season))
ccPermF_pval <- (sum(ccPermF$R >= ccM_Females$R) + 1)/(length(ccPermF$R) + 1)

#Female CC w/ rank
ccPermFrank <- nodePerm(df = CC_Females, n = 2, formula = CC ~ rank + (1|ID) + (1|Season))
ccPermFrank_pval <- (sum(ccPermFrank$R >= ccM_Females_rank$R) + 1)/(length(ccPermFrank$R) + 1)

#Male CC
ccPermM <- nodePerm(df = CC_Males, n = 2, formula = CC ~ (1|ID) + (1|Season))
ccPermM_pval <- (sum(ccPermM$R >= ccM_Males$R) + 1)/(length(ccPermM$R) + 1)

#Male CC w/ rank
ccPermMrank <- nodePerm(df = CC_Males, n = 2, formula = CC ~ rank + (1|ID) + (1|Season))
ccPermMrank_pval <- (sum(ccPermMrank$R >= ccM_Males_rank$R) + 1)/(length(ccPermMrank$R) + 1)
```

## Correlating Metrics

The study used Spearman rank correlations to assess for collinearity between each pair of network metrics. The results can be found in Table 1 of the original study.

```{r}
network_metrics <- data.frame(In.Degree = IO$In, Out.Degree = IO$Out, In.Strength = strength$In, Out.Strength = strength$Out, Eigenvector = EC$EC.vector, Cluster = CC$CC, Between = b$bt)
spearCor <- cor(network_metrics, method = "spearman")
spearCor
```

## Rank and Sex Models

In addition to the repeatability models, the study used (G)LMMs to investigate the effects of sex and rank differences on each of the 7 metrics.

For the sex models, "sex" was included as a fixed effect and ID and Season were again random effects. For the betweenness Poisson GLMM, an observational level random effect was included. After the models were run, node based permutation was run again for 1000 but with sex being randomized instead of ID.

For the rank models, males and females were analyzed separately and "rank" was a fixed effects with ID and Season as random effects. The rest of the analysis matched how the sex model was carried out. All mixed models were fit using functions in the {lme4} package.

Below are the functions needed to do the node based permutations. They have been adjusted slightly to account for the different analysis

```{r}
nodePerm <- function(df, n, formula){
  permN <- do(n) * {
    permd <- df
    permd$Sex = sample(permd$Sex)
    m <- lmer(formula,
             data = permd)
    data.frame(Sex = m$)
  }
  return(permN)
}
nodePermGlmm <- function(df, n, formula){
  permN <- do(n) * {
    permd <- df
    permd$ID = sample(permd$ID)
    m <- rptPoisson(formula,
                    grname = "ID",
                    data = b)
    data.frame(R = m$R$ID)
  }
  return(permN)
}
```

### Sex (G)LMMs

```{r}
#sex as fixed effect
#In/Out Degree
inD_sex <- lmer(In ~ (1|ID) + (1|Season) + Sex,
                data = IO)
summary(inD_sex)

outD_sex <- lmer(Out ~ (1|ID) + (1|Season) + Sex,
                 data = IO)
summary(outD_sex)

#In/Out Strength
inS_sex <- lmer(In ~ (1|ID) + (1|Season) + Sex,
                data = strength)
summary(inS_sex)

outS_sex <- lmer(In ~ (1|ID) + (1|Season) + Sex,
                 data = strength)
summary(outS_sex)

#Eigenvector Centrality
eg_sex <- lmer(EC.vector ~ (1|ID) + (1|Season) + Sex,
               data = EC)
summary(eg_sex)

#Betweenness
b <- b |>
  mutate(observation.id = factor(1:nrow(b)))
bt_sex <- glmer(bt ~ (1|ID) + (1|Season) + (1|observation.id) + Sex,
                data = b,
                family = poisson)
summary(bt_sex)

#Clustering Coefficient
cc_sex <- lmer(CC ~ (1|ID) + (1|Season) + Sex,
               data = CC)
summary(cc_sex)
```

### Rank (G)LMMs

```{r}
inDF_rank <- lmer(In ~ (1|ID) + (1|Season) + rank,
                  data = ioFemales)
summary(inDF_rank)

outDF_rank <- lmer(Out ~ (1|ID) + (1|Season) + rank,
                   data = ioFemales)
summary(outDF_rank)

inSF_rank <- lmer(In ~ (1|ID) + (1|Season) + rank,
                  data = strengthF)
summary(inSF_rank)

outSF_rank <- lmer(Out ~ (1|ID) + (1|Season) + rank,
                   data = strengthF)
summary(outSF_rank)

egF_rank <- lmer(EC.vector ~ (1|ID) + (1|Season) + rank,
                 data = ecFemales)
summary(egF_rank)

bFemales <- bFemales |>
  mutate(observation.id = factor(1:nrow(bFemales)))
btF_rank <- glmer(bt ~ (1|ID) + (1|Season) + (1|observation.id) + rank,
                  data = bFemales,
                  family = poisson)
summary(btF_rank)

ccF_rank <- lmer(CC ~ (1|ID) + (1|Season) + rank,
                 data = CC_Females)
summary(ccF_rank)

#Rank as fixed effect males
inDM_rank <- lmer(In ~ (1|ID) + (1|Season) + rank,
                  data = ioMales)
summary(inDM_rank)

outDM_rank <- lmer(Out ~ (1|ID) + (1|Season) + rank,
                   data = ioMales)
summary(outDF_rank)

inSM_rank <- lmer(In ~ (1|ID) + (1|Season) + rank,
                  data = strengthM)
summary(inSM_rank)

outSM_rank <- lmer(Out ~ (1|ID) + (1|Season) + rank,
                   data = strengthM)
summary(outSM_rank)

egM_rank <- lmer(EC.vector ~ (1|ID) + (1|Season) + rank,
                 data = ecMales)
summary(egM_rank)

bMales <- bMales |>
  mutate(observation.id = factor(1:nrow(bMales)))
btM_rank <- glmer(bt ~ (1|ID) + (1|Season) + (1|observation.id) + rank,
                  data = bMales,
                  family = poisson)
summary(btM_rank)

ccM_rank <- lmer(CC ~ (1|ID) + (1|Season) + rank,
                 data = CC_Males)
summary(ccM_rank)
```
